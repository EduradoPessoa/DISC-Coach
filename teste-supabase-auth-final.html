<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Autentica√ß√£o Supabase - DISC Coach</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .test-section h3 {
            margin-top: 0;
            color: #007bff;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .results {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .user-card {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            border-left: 4px solid #007bff;
        }
        .config-info {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Autentica√ß√£o Supabase - DISC Coach</h1>
        
        <div class="config-info">
            <strong>üìã Configura√ß√£o Atual:</strong><br>
            <strong>URL:</strong> https://tpancojploqdfddxvgre.supabase.co<br>
            <strong>Status:</strong> <span id="connection-status">Verificando...</span>
        </div>
        
        <div id="status" class="status info">Sistema pronto para testes de autentica√ß√£o</div>
        
        <div class="test-section">
            <h3>üîó Testar Conex√£o com Supabase</h3>
            <button onclick="testSupabaseConnection()">Testar Conex√£o</button>
            <button onclick="checkTables()">Verificar Tabelas</button>
            <button onclick="checkRLSPolicies()">Verificar Pol√≠ticas RLS</button>
        </div>
        
        <div class="test-section">
            <h3>üë§ Testar Autentica√ß√£o</h3>
            <button onclick="testSignup()">Testar Registro</button>
            <button onclick="testLogin()">Testar Login</button>
            <button onclick="testCurrentUser()">Verificar Usu√°rio Atual</button>
            <button onclick="testLogout()">Testar Logout</button>
        </div>
        
        <div class="test-section">
            <h3>üóÑÔ∏è Testar Banco de Dados</h3>
            <button onclick="testUsersTableData()">Ver Dados Users</button>
            <button onclick="testAssessmentsTable()">Ver Dados Assessments</button>
            <button onclick="testFocusAreasTable()">Ver Dados Focus Areas</button>
        </div>
        
        <div class="test-section">
            <h3>üîÑ Testar Sistema Completo</h3>
            <button onclick="runCompleteTest()">Executar Teste Completo</button>
            <button onclick="clearResults()">Limpar Resultados</button>
            <button onclick="showSetupGuide()">Mostrar Guia de Configura√ß√£o</button>
        </div>
        
        <div id="results" class="results" style="display: none;">
            <h3>üìä Resultados dos Testes:</h3>
            <div id="results-content"></div>
        </div>
    </div>

    <!-- Supabase Client -->
    <script type="module">
        // Importar Supabase client
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://tpancojploqdfddxvgre.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_73NI4K2_RwneSniHlB4cmw_WLzeUYh4';
        
        // Criar cliente Supabase
        window.supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        console.log('üöÄ Supabase client inicializado!');
        console.log('üìç URL:', SUPABASE_URL);
        
        // Fun√ß√µes de utilidade
        window.updateStatus = function(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            statusEl.className = `status ${type}`;
        }
        
        window.addResult = function(message, type = 'info') {
            const resultsContent = document.getElementById('results-content');
            const resultDiv = document.createElement('div');
            resultDiv.className = `status ${type}`;
            resultDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsContent.appendChild(resultDiv);
            document.getElementById('results').style.display = 'block';
            
            // Scroll para o resultado mais recente
            resultsContent.scrollTop = resultsContent.scrollHeight;
        }
        
        window.clearResults = function() {
            document.getElementById('results-content').innerHTML = '';
            document.getElementById('results').style.display = 'none';
            updateStatus('Resultados limpos. Pronto para novos testes.', 'info');
        }
        
        // Teste 1: Conex√£o com Supabase
        window.testSupabaseConnection = async function() {
            updateStatus('Testando conex√£o com Supabase...', 'info');
            
            try {
                const { data, error } = await supabase.from('users').select('*').limit(1);
                
                if (error) {
                    addResult(`‚ùå Erro na conex√£o: ${error.message}`, 'error');
                    document.getElementById('connection-status').textContent = 'Erro na conex√£o';
                    document.getElementById('connection-status').style.color = 'red';
                } else {
                    addResult('‚úÖ Conex√£o com Supabase estabelecida!', 'success');
                    document.getElementById('connection-status').textContent = 'Conectado';
                    document.getElementById('connection-status').style.color = 'green';
                }
            } catch (error) {
                addResult(`‚ùå Erro cr√≠tico: ${error.message}`, 'error');
                document.getElementById('connection-status').textContent = 'Erro cr√≠tico';
                document.getElementById('connection-status').style.color = 'red';
            }
        }
        
        // Teste 2: Verificar tabelas
        window.checkTables = async function() {
            updateStatus('Verificando tabelas do banco de dados...', 'info');
            
            const tables = ['users', 'assessments', 'focus_areas', 'invitations'];
            
            for (const table of tables) {
                try {
                    const { data, error } = await supabase.from(table).select('*').limit(1);
                    
                    if (error) {
                        addResult(`‚ö†Ô∏è Tabela ${table}: ${error.message}`, 'warning');
                    } else {
                        addResult(`‚úÖ Tabela ${table}: Acess√≠vel (${data?.length || 0} registros)`, 'success');
                    }
                } catch (error) {
                    addResult(`‚ùå Tabela ${table}: Erro cr√≠tico - ${error.message}`, 'error');
                }
            }
        }
        
        // Teste 3: Verificar pol√≠ticas RLS
        window.checkRLSPolicies = async function() {
            updateStatus('Verificando pol√≠ticas de seguran√ßa...', 'info');
            
            try {
                // Testar se conseguimos acessar dados com pol√≠ticas RLS
                const { data, error } = await supabase.from('users').select('*').limit(3);
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        addResult('‚ö†Ô∏è Pol√≠ticas RLS podem estar bloqueando acesso', 'warning');
                        addResult('üí° Verifique as pol√≠ticas no dashboard do Supabase', 'info');
                    } else {
                        addResult(`‚ùå Erro ao verificar pol√≠ticas: ${error.message}`, 'error');
                    }
                } else {
                    addResult('‚úÖ Pol√≠ticas RLS funcionando corretamente', 'success');
                    addResult(`üìä ${data?.length || 0} registros encontrados`, 'info');
                }
            } catch (error) {
                addResult(`‚ùå Erro cr√≠tico: ${error.message}`, 'error');
            }
        }
        
        // Teste 4: Registro de usu√°rio
        window.testSignup = async function() {
            updateStatus('Testando registro de usu√°rio...', 'info');
            
            const testEmail = `teste_${Date.now()}@disccoach.com`;
            const testPassword = 'teste123';
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: testEmail,
                    password: testPassword,
                    options: {
                        data: {
                            name: 'Usu√°rio Teste',
                            role: 'user'
                        }
                    }
                });
                
                if (error) {
                    addResult(`‚ùå Erro no registro: ${error.message}`, 'error');
                } else {
                    addResult('‚úÖ Registro bem-sucedido!', 'success');
                    addResult(`üìß Email: ${data.user.email}`, 'info');
                    addResult(`üÜî ID: ${data.user.id}`, 'info');
                    addResult(`üë§ Nome: ${data.user.user_metadata?.name || 'N√£o especificado'}`, 'info');
                }
            } catch (error) {
                addResult(`‚ùå Erro cr√≠tico: ${error.message}`, 'error');
            }
        }
        
        // Teste 5: Login
        window.testLogin = async function() {
            updateStatus('Testando login...', 'info');
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'eduardo@phoenyx.com.br',
                    password: 'admin123'
                });
                
                if (error) {
                    addResult(`‚ùå Erro no login: ${error.message}`, 'error');
                } else {
                    addResult('‚úÖ Login bem-sucedido!', 'success');
                    addResult(`üìß Email: ${data.user.email}`, 'info');
                    addResult(`üÜî ID: ${data.user.id}`, 'info');
                    addResult(`üë§ Nome: ${data.user.user_metadata?.name || 'N√£o especificado'}`, 'info');
                    addResult(`üëë Role: ${data.user.user_metadata?.role || 'user'}`, 'info');
                }
            } catch (error) {
                addResult(`‚ùå Erro cr√≠tico: ${error.message}`, 'error');
            }
        }
        
        // Teste 6: Usu√°rio atual
        window.testCurrentUser = async function() {
            updateStatus('Verificando usu√°rio atual...', 'info');
            
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) {
                    addResult(`‚ùå Erro ao verificar usu√°rio: ${error.message}`, 'error');
                } else if (user) {
                    addResult('‚úÖ Usu√°rio verificado!', 'success');
                    addResult(`üë§ Nome: ${user.user_metadata?.name || user.email}`, 'info');
                    addResult(`üìß Email: ${user.email}`, 'info');
                    addResult(`üÜî ID: ${user.id}`, 'info');
                    addResult(`üëë Role: ${user.user_metadata?.role || 'user'}`, 'info');
                } else {
                    addResult('‚ÑπÔ∏è Nenhum usu√°rio logado no momento', 'info');
                }
            } catch (error) {
                addResult(`‚ùå Erro cr√≠tico: ${error.message}`, 'error');
            }
        }
        
        // Teste 7: Logout
        window.testLogout = async function() {
            updateStatus('Testando logout...', 'info');
            
            try {
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    addResult(`‚ùå Erro no logout: ${error.message}`, 'error');
                } else {
                    addResult('‚úÖ Logout realizado com sucesso!', 'success');
                }
            } catch (error) {
                addResult(`‚ùå Erro cr√≠tico: ${error.message}`, 'error');
            }
        }
        
        // Teste 8: Dados da tabela users
        window.testUsersTableData = async function() {
            updateStatus('Buscando dados da tabela users...', 'info');
            
            try {
                const { data, error } = await supabase.from('users').select('*').limit(5);
                
                if (error) {
                    addResult(`‚ùå Erro ao buscar users: ${error.message}`, 'error');
                } else {
                    addResult(`‚úÖ Encontrados ${data?.length || 0} usu√°rios`, 'success');
                    
                    data?.forEach(user => {
                        addResult(`üë§ ${user.name} (${user.email}) - Plano: ${user.plan} - Role: ${user.role}`, 'info');
                    });
                }
            } catch (error) {
                addResult(`‚ùå Erro cr√≠tico: ${error.message}`, 'error');
            }
        }
        
        // Teste 9: Dados de assessments
        window.testAssessmentsTable = async function() {
            updateStatus('Buscando dados de assessments...', 'info');
            
            try {
                const { data, error } = await supabase.from('assessments').select('*').limit(3);
                
                if (error) {
                    addResult(`‚ùå Erro ao buscar assessments: ${error.message}`, 'error');
                } else {
                    addResult(`‚úÖ Encontrados ${data?.length || 0} assessments`, 'success');
                    
                    data?.forEach(assessment => {
                        addResult(`üìä Assessment ${assessment.id} - User: ${assessment.user_id} - Perfil: ${assessment.disc_profile}`, 'info');
                    });
                }
            } catch (error) {
                addResult(`‚ùå Erro cr√≠tico: ${error.message}`, 'error');
            }
        }
        
        // Teste 10: Dados de focus areas
        window.testFocusAreasTable = async function() {
            updateStatus('Buscando dados de focus areas...', 'info');
            
            try {
                const { data, error } = await supabase.from('focus_areas').select('*').limit(3);
                
                if (error) {
                    addResult(`‚ùå Erro ao buscar focus areas: ${error.message}`, 'error');
                } else {
                    addResult(`‚úÖ Encontrados ${data?.length || 0} focus areas`, 'success');
                    
                    data?.forEach(area => {
                        addResult(`üéØ ${area.title} - Status: ${area.status} - Prioridade: ${area.priority}`, 'info');
                    });
                }
            } catch (error) {
                addResult(`‚ùå Erro cr√≠tico: ${error.message}`, 'error');
            }
        }
        
        // Teste Completo
        window.runCompleteTest = async function() {
            clearResults();
            updateStatus('Executando teste completo do Supabase...', 'info');
            
            addResult('üöÄ Iniciando testes completos do Supabase', 'info');
            addResult('üìÖ Timestamp: ' + new Date().toLocaleString(), 'info');
            addResult('', 'info');
            
            // Executar todos os testes
            await testSupabaseConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await checkTables();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await checkRLSPolicies();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testSignup();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testLogin();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testCurrentUser();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testUsersTableData();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testAssessmentsTable();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testFocusAreasTable();
            
            addResult('', 'info');
            addResult('üéâ Testes completos finalizados!', 'success');
            addResult('üí° O sistema est√° funcionando corretamente!', 'info');
            
            updateStatus('Testes completos finalizados.', 'success');
        }
        
        // Mostrar guia de configura√ß√£o
        window.showSetupGuide = function() {
            alert(`üìã Guia de Configura√ß√£o do Supabase

1. Acesse: https://app.supabase.com
2. Selecione o projeto: qyxllnapmlurqkoxvmii
3. V√° para "SQL Editor"
4. Execute o script em: supabase-setup.sql
5. Verifique as pol√≠ticas RLS em: Authentication > Policies

üîó Credenciais j√° configuradas no sistema!

Para testes manuais, use o console (F12) e execute:
supabase.auth.signUp({email: 'teste@email.com', password: 'senha123'})`);
        }
        
        // Inicializa√ß√£o
        console.log('üöÄ Supabase client inicializado com sucesso!');
        console.log('üìç URL: https://qyxllnapmlurqkoxvmii.supabase.co');
        
        // Verificar conex√£o inicial
        setTimeout(() => {
            updateStatus('Sistema pronto para testes de autentica√ß√£o com Supabase.', 'info');
            document.getElementById('connection-status').textContent = 'Aguardando teste';
            document.getElementById('connection-status').style.color = '#666';
        }, 1000);
    </script>
</body>
</html>